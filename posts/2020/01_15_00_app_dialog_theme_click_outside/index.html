<!doctype html><html lang=ja><head><meta charset=utf-8><link crossorigin=anonymous media=all rel=stylesheet href=https://suihan74.github.io/css/frameworks.css?20200318001352><link crossorigin=anonymous media=all rel=stylesheet href=https://suihan74.github.io/css/github.css?20200318001352><link crossorigin=anonymous media=all rel=stylesheet href=https://suihan74.github.io/css/user.css?20200318001352><meta name=viewport content="width=device-width"><title>ダイアログ化したActivityの外側タップを検知する - すいはんぶろぐ.io</title><meta property="og:url" content="https://suihan74.github.io/posts/2020/01_15_00_app_dialog_theme_click_outside/"><meta property="og:site_name" content="すいはんぶろぐ.io"><meta property="og:type" content="article"><meta property="og:title" content="ダイアログ化したActivityの外側タップを検知する"><meta property="og:description" content="AppDialogThemeが設定されたActivityの外側をタップするとActivityが閉じるが、その前に何らかの処理を追加する方法"><meta name=description content="AppDialogThemeが設定されたActivityの外側をタップするとActivityが閉じるが、その前に何らかの処理を追加する方法"><link rel=icon type=image/x-icon class=js-site-favicon href=https://suihan74.github.io/favicon.ico><link rel="shortcut icon" href=https://suihan74.github.io/favicon.ico><meta name=theme-color content="#1e2327"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-71542625-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-71542625-2');</script></head><body class="env-production emoji-size-boost page-responsive page-profile"><div class="position-relative js-header-wrapper"><span class="Progress progress-pjax-loader position-fixed width-full js-pjax-loader-bar"><span class="progress-pjax-loader-bar top-0 left-0" style=width:0%></span></span><div class="Header js-details-container Details flex-wrap flex-lg-nowrap p-responsive" role=banner><div class="Header-item d-none d-lg-flex"><a class=Header-link href=https://suihan74.github.io/ aria-label=Homepage data-ga-click="Header, go to dashboard, icon:logo"><svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" width="32" aria-hidden="true"><path style="fill-rule:evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.077797-1.481017-.077797-2.151017C5.9433346 12.597005 6.1160655 11.824118 6.56 11.53 4.78 11.33 3.8013559 10.978983 3.5810169 7.6647458 3.9355372 4.6446549 5.3653277 3.8240736 8.0538984 3.639661 10.967753 3.8102868 12.141357 4.4459308 12.425085 7.6477967 12.255593 10.378813 11.25 11.33 9.47 11.53c.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38C13.806446 14.490656 15.999121 11.437004 16 8c0-4.42-3.58-8-8-8z" /><rect style="fill-rule:evenodd" ry=".23728813" y="6.3898306" x="6.0169492" height="1.0847455" width="3.9830508"/></svg><span style=margin-left:8px>すいはんぶろぐ.io</span></a></div><div class="Header-item Header-item--full flex-column flex-lg-row width-full flex-order-2 flex-lg-order-none mr-0 mr-lg-3 mt-3 mt-lg-0 Details-content--hidden"><div class="header-search flex-self-stretch flex-lg-self-auto mr-0 mr-lg-3 mb-3 mb-lg-0 scoped-search site-scoped-search js-site-search position-relative js-jump-to" role=combobox aria-owns=jump-to-results aria-label="Search or jump to" aria-haspopup=listbox aria-expanded=false><div class=position-relative></div></div></div><div class="Header-item Header-item--full flex-justify-center d-lg-none position-relative" style=margin-right:auto><a class=Header-link href=https://suihan74.github.io/ aria-label=Homepage data-ga-click="Header, go to dashboard, icon:logo"><svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" width="32" aria-hidden="true"><path style="fill-rule:evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.077797-1.481017-.077797-2.151017C5.9433346 12.597005 6.1160655 11.824118 6.56 11.53 4.78 11.33 3.8013559 10.978983 3.5810169 7.6647458 3.9355372 4.6446549 5.3653277 3.8240736 8.0538984 3.639661 10.967753 3.8102868 12.141357 4.4459308 12.425085 7.6477967 12.255593 10.378813 11.25 11.33 9.47 11.53c.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38C13.806446 14.490656 15.999121 11.437004 16 8c0-4.42-3.58-8-8-8z" /><rect style="fill-rule:evenodd" ry=".23728813" y="6.3898306" x="6.0169492" height="1.0847455" width="3.9830508"/></svg>すいはんぶろぐ.io</a></div><div class="Header-item position-relative mr-0 d-none d-lg-flex Details-content--hidden"><div class="header-search flex-self-stretch flex-lg-self-auto mr-0 mr-lg-3 mb-3 mb-lg-0 position-relative js-jump-to"><div class=position-relative><form class=js-site-search-form role=search action=https://cse.google.com/cse method=get><input type=hidden name=cx value=006598476776954487838:x6qvcxfxgqt>
<label class="form-control input-sm header-search-wrapper p-0 header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center js-chromeless-input-container"><input type=text class="form-control input-sm header-search-input" name=q placeholder=Search autocapitalize=off aria-label=Search spellcheck=false onkeydown="if(event.keyCode==13){if(this.value.length){document.getElementById('header-search-submit').click();return false}else{return false}};" autocomplete=off>
<button id=header-search-submit class="mr-1 ml-1 header-search-button" type=submit><svg class="header-search-button-icon" width="13" height="13" viewBox="0 0 13 13"><title>サイト内検索</title><path d="m4.8495 7.8226c.82666.0 1.5262-.29146 2.0985-.87438.57232-.58292.86378-1.2877.87438-2.1144.010599-.82666-.28086-1.5262-.87438-2.0985-.59352-.57232-1.293-.86378-2.0985-.87438-.8055-.010599-1.5103.28086-2.1144.87438-.60414.59352-.8956 1.293-.87438 2.0985.021197.8055.31266 1.5103.87438 2.1144.56172.60414 1.2665.8956 2.1144.87438zm4.4695.2115 3.681 3.6819-1.259 1.284-3.6817-3.7.0019784-.69479-.090043-.098846c-.87973.76087-1.92 1.1413-3.1207 1.1413-1.3553.0-2.5025-.46363-3.4417-1.3909s-1.4088-2.0686-1.4088-3.4239.4696-2.4966 1.4088-3.4239c.9392-.92727 2.0864-1.3969 3.4417-1.4088 1.3553-.011889 2.4906.45771 3.406 1.4088.9154.95107 1.379 2.0924 1.3909 3.4239.0 1.2126-.38043 2.2588-1.1413 3.1385l.098834.090049z"/></svg></button></label></form></div></div></div></header></div><div id=start-of-content class=show-on-focus></div><div id=js-flash-container></div><div class=application-main data-commit-hovercards-enabled><div itemscope itemtype=http://schema.org/SoftwareSourceCode><main id=js-repo-pjax-container data-pjax-container><div class="pagehead repohead instapaper_ignore readability-menu experiment-repo-nav pt-lg-4"><div class="repohead-details-container clearfix container-lg p-responsive d-lg-block"><div class="mb-3 d-flex"><h1 class="public css-truncate float-none flex-auto width-fit pl-0"><a class="avatar mr-1" href=https://suihan74.github.io/about/><img src=/images/author.png width=26 height=26></a>
<span class=author><a href=https://suihan74.github.io/about/>すいはん</a></span>
<span class=path-divider>/</span>
<strong itemprop=name><a href=https://suihan74.github.io/posts/2020/01_15_00_app_dialog_theme_click_outside/>ダイアログ化したActivityの外側タップを検知する</a></strong><div class="text-small text-gray">AppDialogThemeが設定されたActivityの外側をタップするとActivityが閉じるが、その前に何らかの処理を追加する方法</div><div class="text-small text-gray"><svg class="octicon octicon-tag" viewBox="0 0 14 16" width="14" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.73 1.73C7.26 1.26 6.62 1 5.96 1H3.5C2.13 1 1 2.13 1 3.5v2.47c0 .66.27 1.3.73 1.77l6.06 6.06c.39.39 1.02.39 1.41.0l4.59-4.59a.996.996.0 000-1.41L7.73 1.73zM2.38 7.09c-.31-.3-.47-.7-.47-1.13V3.5c0-.88.72-1.59 1.59-1.59h2.47c.42.0.83.16 1.13.47l6.14 6.13-4.73 4.73-6.13-6.15zM3.01 3h2v2H3V3h.01z" /></svg><a href=/tags/android/>android</a> <a href=/tags/kotlin/>kotlin</a> <a href=/tags/activity/>activity</a></div><div class="d-block text-small text-gray">Created at <time datetime="2020-01-15 01:30" class=no-wrap>2020/01/15 01:30</time>
<span class=file-info-divider></span>Updated at <time datetime="2020-01-17 01:30" class=no-wrap>2020/01/17 01:30</time></div></h1></div></div></div><div class="container-lg clearfix new-discussion-timeline experiment-repo-nav p-responsive"><div class=repository-content><div class="Box mt-3 position-relative"><div class="Box-header py-2 d-flex flex-column flex-shrink-0 flex-md-row flex-md-items-center"><div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">1281 Words</div><div class="d-flex py-1 py-md-0 flex-auto flex-order-1 flex-md-order-2 flex-sm-grow-0 flex-justify-between"><div class=BtnGroup><a rel=nofollow class="btn btn-sm BtnGroup-item" href=https://github.com/suihan74/hugo_files/commits/master/content/posts/2020/01_15_00_app_dialog_theme_click_outside.md>History</a></div></div></div><div id=readme class="Box-body readme blob instapaper_body js-code-block-container"><article class="markdown-body entry-content p-3 p-md-6" itemprop=text><h2 id=追記-2020-01-17-0130>追記 (2020-01-17 01:30)<a class=anchor aria-hidden=true href=#追記-2020-01-17-0130><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a></h2><p>記述例の<code>DialogActivity</code>を表示するために<code>android:theme</code>に設定する値がプロジェクト内で自分で用意したスタイルになっていたので修正。</p><p>修正前: <code>@style/AppDialogTheme</code><br>↓<br>修正後: <code>@style/Theme.AppCompat.Dialog</code></p><hr><h1 id=activityをダイアログ表示する>Activityをダイアログ表示する<a class=anchor aria-hidden=true href=#activityをダイアログ表示する><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a></h1><p><code>android:theme</code>に<code>@style/Theme.AppCompat.Dialog</code>を設定した<code>Activity</code>はダイアログとして表示される。(以下<code>DialogActivity</code>と呼称することにする)</p><p>次のは<a href="https://play.google.com/store/apps/details?id=com.suihan74.satena">Satena</a>のブクマ投稿画面を抜粋。</p><h2 id=androidmanifestxmlhttpsgithubcomsuihan74satenablobmasterappsrcmainandroidmanifestxml><a href=https://github.com/suihan74/Satena/blob/master/app/src/main/AndroidManifest.xml>AndroidManifest.xml</a><a class=anchor aria-hidden=true href=#androidmanifestxmlhttpsgithubcomsuihan74satenablobmasterappsrcmainandroidmanifestxml><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a></h2><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;activity</span>
        <span style=color:#a6e22e>android:name=</span><span style=color:#e6db74>&#34;.scenes.post2.BookmarkPostActivity&#34;</span>
        <span style=color:#a6e22e>android:theme=</span><span style=color:#e6db74>&#34;@style/Theme.AppCompat.Dialog&#34;</span><span style=color:#f92672>&gt;</span>
    ...
<span style=color:#f92672>&lt;/activity&gt;</span>
</code></pre></td></tr></table></div></div><h2 id=様子>様子<a class=anchor aria-hidden=true href=#様子><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a></h2><p><img src=/images/2020/01_15_00_00.png alt=様子 title=Activityは最前面にダイアログ表示されている。></p><p><code>Activity</code>は最前面にダイアログ表示されている。</p><h1 id=ダイアログ外側をタップで閉じる>ダイアログ外側をタップで閉じる<a class=anchor aria-hidden=true href=#ダイアログ外側をタップで閉じる><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a></h1><p><code>DialogActivity</code>の外側は暗くなっていて、この部分をタップすると<code>DialogActivity</code>が閉じて、その下に表示されている画面に処理が戻る。</p><p><code>DialogActivity</code>が何らかの結果を呼び出し元に返すことを期待している場合などに、この「外側タップしてからダイアログが閉じるまでの間」に処理を追加したい、というのが今回の内容である。</p><h3 id=関連記事>関連記事<a class=anchor aria-hidden=true href=#関連記事><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a></h3><p><a href=/posts/2020/01_07_00_start_activity_for_result/>結果を返すActivityを呼ぶ</a></p><h1 id=閉じる前に処理を追加する>閉じる前に処理を追加する<a class=anchor aria-hidden=true href=#閉じる前に処理を追加する><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a></h1><p><code>onTouchEvent(...)</code>はダイアログ外側のタップにも反応する。<br>タップされた位置から<code>DialogActivity</code>の外側であることを判別するようにするのが楽そうな解決策だった。</p><h2 id=dialogactivitykt>DialogActivity.kt<a class=anchor aria-hidden=true href=#dialogactivitykt><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a></h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kt data-lang=kt><span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onTouchEvent</span>(event: MotionEvent?): Boolean {
    <span style=color:#75715e>// Activityの外側をタップして閉じる際に、結果を渡しておく
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (event<span style=color:#f92672>?.</span>action == MotionEvent.ACTION_DOWN &amp;&amp; isOutOfBounds(event)) {
        <span style=color:#66d9ef>val</span> intent = Intent().apply {
            putExtra(RESULT_HOGE, viewModel.hoge.value)
        }
        setResult(RESULT_CANCELED, intent)
    }
    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.onTouchEvent(event)
}

<span style=color:#75715e>/** Activityの外側をタップしたかを判別する */</span>
<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>isOutOfBounds</span>(event: MotionEvent): Boolean {
    <span style=color:#66d9ef>val</span> x = event.x.toInt()
    <span style=color:#66d9ef>val</span> y = event.y.toInt()
    <span style=color:#66d9ef>val</span> dialogBounds = Rect()
    window.decorView.getHitRect(dialogBounds)
    <span style=color:#66d9ef>return</span> !dialogBounds.contains(x, y)
}
</code></pre></div><p>ちなみに<code>MotionEvent.ACTION_UP</code>だと先にダイアログが閉じてしまって駄目だった。</p><h3 id=参考>参考<a class=anchor aria-hidden=true href=#参考><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a></h3><p><a href=https://stackoverflow.com/a/24435357>android - How to dismiss the dialog with click on outside of the dialog? - Stack Overflow</a></p><hr><h1 id=余談1>余談1<a class=anchor aria-hidden=true href=#余談1><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a></h1><p><code>DialogActivity</code>の外側タップを検知する方法を調べていると、よくヒットしたのは別の方法だった。(上記の参考先StackOverflowのページでも以下の方法とそれで発生する問題について言及されている)</p><ol><li><p><code>onCreate()</code>などで次のようなフラグをセットする。<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin>window.addFlags(WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL)
window.addFlags(WindowManager.LayoutParams.FLAG_WATCH_OUTSIDE_TOUCH)</code></pre></div></p></li><li><p><code>onTouchEvent()</code>で<code>MotionEvent.ACTION_OUTSIDE</code>を検知する。<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onTouchEvent</span>(event: MotionEvent?): Boolean {
    <span style=color:#66d9ef>if</span> (event<span style=color:#f92672>?.</span>action == MotionEvent.ACTION_OUTSIDE) {
        ...
    }
    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.onTouchEvent(event)
}</code></pre></div></p></li></ol><p>この方法を用いると確かに外側タップは検出できるのだが、どういうわけかタップが下にある画面にも伝播してしまう問題があった。<br>フラグの設定方法や組み合わせやら<code>onTouchEvent()</code>の戻り値やらを色々変えて試してみたが、<br><code>MotionEvent.ACTION_OUTSIDE</code>を検出する方法をとった上でタップが伝播する問題を回避する方法はわからなかった。</p><p>詳しく調べまわったりはそれほどしていないので実際のところ回避方法があるかはわからないが、無かったところで今回記事の方法で要件は満足しているのでとくに問題もないような気がする。</p><h1 id=余談2>余談2<a class=anchor aria-hidden=true href=#余談2><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5.0-3-1.69-3-3.5S2.55 3 4 3h4c1.45.0 3 1.69 3 3.5.0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98.0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98.0-2-1.22-2-2.5.0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45.0 3-1.69 3-3.5S14.5 6 13 6z"/></svg></a></h1><p>外側の暗いところをタップしてもダイアログを閉じないようにするには<code>onCreate(...)</code>などで次のメソッドを実行すれば良い。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kt data-lang=kt>setFinishOnTouchOutside(<span style=color:#66d9ef>false</span>)
</code></pre></div></article></div></div></div></div></main></div></div><div class=utterances><script src=https://utteranc.es/client.js repo=suihan74/suihan74.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></div><div class="footer container-lg width-full p-responsive" role=contentinfo><div class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light"><ul class="list-style-none d-flex flex-wrap col-12 col-lg-5 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0"><li class="mr-3 mr-lg-0">© 2020 すいはん. Theme by <a href=https://github.com/MeiK2333/github-style><span>github-style</span></a> (<a href=https://github.com/suihan74/github-style><span>customized</span></a>)</li></ul><a aria-label=Homepage title=すいはんぶろぐ.io class="footer-octicon d-none d-lg-block mx-lg-4" href=https://suihan74.github.io/><svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" width="24" aria-hidden="true"><path style="fill-rule:evenodd" d="M8 0C3.58.0.0 3.58.0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38.0-.19-.077797-1.481017-.077797-2.151017C5.9433346 12.597005 6.1160655 11.824118 6.56 11.53 4.78 11.33 3.8013559 10.978983 3.5810169 7.6647458 3.9355372 4.6446549 5.3653277 3.8240736 8.0538984 3.639661 10.967753 3.8102868 12.141357 4.4459308 12.425085 7.6477967 12.255593 10.378813 11.25 11.33 9.47 11.53c.29.25.54.73.54 1.48.0 1.07-.01 1.93-.01 2.2.0.21.15.46.55.38C13.806446 14.490656 15.999121 11.437004 16 8c0-4.42-3.58-8-8-8z" /><rect style="fill-rule:evenodd" ry=".23728813" y="6.3898306" x="6.0169492" height="1.0847455" width="3.9830508"/></svg></a><ul class="list-style-none d-flex flex-wrap col-12 col-lg-5 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0"></ul></div><div class="d-flex flex-justify-center pb-6"><span class="f6 text-gray-light"></span></div></div><script crossorigin=anonymous type=application/javascript src=https://suihan74.github.io/js/frameworks.js></script><script crossorigin=anonymous async type=application/javascript src=https://suihan74.github.io/js/github-bootstrap.js></script><script>let classs=['pinned-item-desc','text-gray','text-small','d-block','mt-2','mb-3'];const pinned_posts=document.getElementsByName('pinned-post');for(let i=0;i<pinned_posts.length;i++){for(let j=0;j<classs.length;j++){const ps=pinned_posts[i].getElementsByTagName('p');for(let k=0;k<ps.length;k++){ps[k].classList.add(classs[j]);}}}
classs=['d-inline-block','text-gray','mb-2','pr-4'];const posts_posts=document.getElementsByName('posts-post');for(let i=0;i<posts_posts.length;i++){for(let j=0;j<classs.length;j++){const ps=posts_posts[i].getElementsByTagName('p');for(let k=0;k<ps.length;k++){ps[k].classList.add(classs[j]);}}}</script></body></html>